function DMModule(a,b){this.uuid=DMUtils.uuid(),this._before=[],this._after=[],this._add={callback:a,context:b},this.ready=!1}function DMExec(a,b,c){this.module=a,this.node=b,this.args=c,this._state=0,this._index=0,this.context=null,this._waiting=null,this._timer=null}var DM,DMUtils;DMUtils={each:function(a,b,c){var d;for(d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a)},map:function(a,b,c){return a.map(b,c)},all:function(a,b){return b instanceof HTMLElement||b instanceof HTMLDocument||(b=document),b.querySelectorAll(a)},trim:function(a){return a.trim()},getModules:function(a){return DMUtils.map(a.getAttribute("data-marker").match(/([a-z\-]+(\[[^[]+\])?)/gi)||[],function(a){var b,c,d=a.match(/[^\[\]]+/gi);return b=d.shift(),c=d[0]?DMUtils.map(d[0].split(","),DMUtils.trim):[],DMUtils.each(c,function(a,b,c){"false"===a?c[b]=!1:"true"===a?c[b]=!0:a==parseFloat(a)?c[b]=parseFloat(a):"null"===a&&(c[b]=null)}),{name:b,args:c}})},filter:function(a,b){return a.filter(b)},filterModules:function(a,b,c){return DMUtils.filter(b,function(b){var d,e=a._dm||(a._dm={}),f=!1;return d=c[b.name]&&c[b.name].uuid,e[d]||(f=e[d]=!0),f})},uuid:function(){var a=0;return function(){return++a}}()},DMModule.prototype._sort=function(a){return a.sort(function(a,b){var c;return c=a.weight===b.weight?0:a.weight>b.weight?1:-1}),this},DMModule.prototype.prepare=function(){return this._sort(this._before)._sort(this._after),this.ready=!0,this},DMModule.prototype.before=function(a,b,c){var d=DMUtils.uuid();return this.ready=!1,this._before.push({callback:a,context:b,weight:c||0,uuid:d}),d},DMModule.prototype.after=function(a,b,c){var d=DMUtils.uuid();return this.ready=!1,this._after.push({callback:a,context:b,weight:c||0,uuid:d}),d},DMExec.STATES={INITIAL:0,BEFORE:1,MAIN:2,AFTER:3,FINISHED:4},DMExec.TYPES={NEXT:"next",STOP:"stop"},DMExec.prototype.next=function(){this._waiting&&(this._waiting=!1,clearTimeout(this._timer)),this._index++,this.execute(DMExec.TYPES.NEXT)},DMExec.prototype.stop=function(){this._waiting&&(this._waiting=!1,clearTimeout(this._timer)),this._index=0,this._state=DMExec.STATES.FINISHED,this.execute(DMExec.TYPES.STOP)},DMExec.prototype.execute=function(a){var b,c=DMExec.STATES,d=DMExec.TYPES,e=this.module;switch((a!==d.NEXT||this._state!==c.INITIAL)&&(e.ready||e.prepare()),this._state===c.INITIAL&&(this._state=c.BEFORE),this._state){case c.BEFORE:case c.AFTER:b=e[this._state===c.BEFORE?"_before":"_after"][this._index],b&&"function"==typeof b.callback?(this.context=b.context,b.callback.apply(this,this.args)):(this._state=this._state===c.BEFORE?c.MAIN:c.FINISHED,this._index=-1);break;case c.MAIN:this._state=c.AFTER,this._index=-1,"function"==typeof e._add.callback&&(this.context=e._add.context,e._add.callback.apply(this,this.args));break;case c.FINISHED:this._state=c.INITIAL,this._index=0,this.context=null}return this._state===c.INITIAL||this._waiting||this.next(),this},DMExec.prototype.wait=function(a,b){var c=this;this._waiting=!0,this._timer=setTimeout(function(){c[b?"stop":"next"]()},a||5e3)},DM=function(a){function b(b){e?b():a.engines.y?a.engines.y().use("node-base","array-extras",function(a){DMUtils.all=function(b){return a.all(b).getDOMNodes()},DMUtils.map=function(b,c,d){return a.Array.map(b,c,d)},DMUtils.filter=function(b,c){return a.Array.filter(b,c)},DMUtils.trim=function(b){return a.Lang.trim(b)},e=a,b()}):a.engines.j?(e=a.engines.j,DMUtils.all=function(a,b){return Array.prototype.slice.call(e(a,b))},DMUtils.map=function(a,b){return e.map(a,b)},DMUtils.filter=function(a,b){return e.grep(a,b)},DMUtils.trim=function(a){return e.trim(a)},b()):(e=!0,b())}function c(a,b,c){return f[a]=new DMModule(b,c)}function d(a){var b=f[a];return b instanceof DMModule?b:!1}var e,f={};return{add:function(a,b,e){var f=d(a);if(f){if("function"==typeof f._add.callback)throw new Error("Module("+a+") main callback is already defined");f._add.callback=b,f._add.context=e}else f=c(a,b,e);return f.uuid},before:function(a,b,e,f){var g=d(a)||c(a);if("function"!=typeof b)throw new Error("Callback should be a function");return g.before(b,e,f)},after:function(a,b,e,f){var g=d(a)||c(a);if("function"!=typeof b)throw new Error("Callback should be a function");return g.after(b,e,f)},go:function(){return b(function(){var b=DMUtils.all("[data-marker]",a.env.document);DMUtils.each(Array.prototype.slice.call(b),function(a){var b=DMUtils.getModules(a);b=DMUtils.filterModules(a,b,f),DMUtils.each(b,function(b){var c=d(b.name);c&&new DMExec(c,a,b.args).execute()})})}),this},detach:function(a){var b,c,d,e,g=!1;for(b in f)if(f.hasOwnProperty(b)){if(e=f[b],e.uuid===a)e._add.context=null,e._add.callback=null,g=!0;else{for(c in e._before)if(e._before.hasOwnProperty(c)&&(d=e._before[c],d.uuid===a)){e._before.splice(c,1),g=!0;break}if(!g)for(c in e._after)if(e._after.hasOwnProperty(c)&&(d=e._after[c],d.uuid===a)){e._after.splice(c,1),g=!0;break}}if(g)break}return this},remove:function(a){return f[a]&&delete f[a],this},removeAll:function(){return f={},this}}}({env:{win:"undefined"!=typeof window&&window,document:"undefined"!=typeof document&&document},engines:{j:"function"==typeof jQuery&&jQuery,y:"function"==typeof YUI&&YUI}});
/*! dm (git://github.com/jslayer/dm.js.git) | v0.4.0 | MIT */
function DMModule(a,b,c,d){this.uuid=DMUtils.uuid(),this._dependency=[],this._before=[],this._after=[],this._instances=[],this._add={callback:b,context:c},this.name=a,this.ready=!1,DMUtils.each(d,function(a){this._dependency.push({name:a,context:null,instances:[]})},this)}function DMExec(a,b,c,d){this.module=a,this.node=b,this.args=c,this._state=0,this._index=0,this.context=null,this._waiting=null,this._finish=d,this._timer=null}var DM,DMUtils;DMUtils={each:function(a,b,c){var d;for(d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a)},map:function(a,b,c){return a.map(b,c)},all:function(a,b){return b instanceof Element||b instanceof HTMLDocument||(b=document),b.querySelectorAll(a)},trim:function(a){return a.trim()},getModules:function(a,b){return DMUtils.map(a.getAttribute(b).match(/([a-z\-]+(\[[^[]+\])?)/gi)||[],function(a){var b,c,d=a.match(/[^\[\]]+/gi);return b=d.shift(),c=d[0]?DMUtils.map(d[0].split(","),DMUtils.trim):[],DMUtils.each(c,function(a,b,c){"false"===a?c[b]=!1:"true"===a?c[b]=!0:a==parseFloat(a)?c[b]=parseFloat(a):"null"===a&&(c[b]=null)}),{name:b,args:c}})},filter:function(a,b){return a.filter(b)},filterModules:function(a,b,c){return DMUtils.filter(b,function(b){var d,e=a._dm||(a._dm={}),f=!1;return d=c[b.name]&&c[b.name].uuid,e[d]||(f=e[d]=!0),f})},updateNodeState:function(a,b,c,d){var e,f,g;return e=a._dm||(a._dm={}),f=c[b.name]&&c[b.name].uuid,g=e[f]||1,e[f]=d||g,g!==d},shouldProcessNode:function(a,b,c){var d,e,f;return d=a._dm||(a._dm={}),e=c[b.name]&&c[b.name].uuid,f=d[e]?d[e]:d[e]=1},keysCount:function(a){var b;for(b in a)a.hasOwnProperty(b)&&b++;return b},inSort:function(a){var b,c,d,e;for(b=1,c=this.length;c>b;b++){for(e=this[b],d=b-1;d>=0&&a?a(this[d],e)>0:this[d]>e;)this[d+1]=this[d],d-=1;this[d+1]=e}return this},uuid:function(){var a=0;return function(){return++a}}()},DMModule.prototype._sort=function(a){return a.sort(function(a,b){var c;return c=a.weight===b.weight?0:a.weight>b.weight?1:-1}),this},DMModule.prototype.prepare=function(){return this._sort(this._before)._sort(this._after),this.ready=!0,this},DMModule.prototype.before=function(a,b,c){var d=DMUtils.uuid();return this.ready=!1,this._before.push({callback:a,context:b,weight:c||0,uuid:d}),d},DMModule.prototype.after=function(a,b,c){var d=DMUtils.uuid();return this.ready=!1,this._after.push({callback:a,context:b,weight:c||0,uuid:d}),d},DMExec.STATES={INITIAL:0,BEFORE:1,MAIN:2,AFTER:3,FINISHED:4},DMExec.TYPES={NEXT:"next",STOP:"stop"},DMExec.prototype.next=function(){this._waiting&&(this._waiting=!1,clearTimeout(this._timer)),this._index++,this.execute(DMExec.TYPES.NEXT)},DMExec.prototype.stop=function(){this._waiting&&(this._waiting=!1,clearTimeout(this._timer)),this._index=0,this._state=DMExec.STATES.FINISHED,this.execute(DMExec.TYPES.STOP)},DMExec.prototype.execute=function(a){var b,c=DMExec.STATES,d=DMExec.TYPES,e=this.module;switch((a!==d.NEXT||this._state!==c.INITIAL)&&(e.ready||e.prepare()),this._state===c.INITIAL&&(this._state=c.BEFORE),this._state){case c.BEFORE:case c.AFTER:b=e[this._state===c.BEFORE?"_before":"_after"][this._index],b&&"function"==typeof b.callback?(this.context=b.context,b.callback.apply(this,this.args)):(this._state=this._state===c.BEFORE?c.MAIN:c.FINISHED,this._index=-1);break;case c.MAIN:this._state=c.AFTER,this._index=-1,"function"==typeof e._add.callback&&(this.context=e._add.context,e._add.callback.apply(this,this.args));break;case c.FINISHED:this._state=c.INITIAL,this._index=0,this.context=null,"function"==typeof this._finish&&this._finish.call(this)}return this._state===c.INITIAL||this._waiting||this.next(),this},DMExec.prototype.wait=function(a,b){var c=this;this._waiting=!0,this._timer=setTimeout(function(){c[b?"stop":"next"]()},a||5e3)},DMExec.prototype.children=function(){var a,b,c={};return a="data-"+this.module.name,b=DMUtils.all("["+a+"]",this.node),DMUtils.each(Array.prototype.slice.call(b),function(b){DMUtils.each(DMUtils.getModules(b,a),function(a){c[a.name]||(c[a.name]=[]),c[a.name].push({node:b,args:a.args})})},this),c},DMExec.prototype.dependency=function(a){var b,c,d;for(d=this.module._dependency,b=0,c=d.length;c>b;b++)if(d[b].name===a)return d[b]},DM=function(a){function b(b){g?b():a.engines.y?a.engines.y().use("node-base","array-extras",function(a){DMUtils.all=function(b,c){return(c?a.one(c):a).all(b).getDOMNodes()},DMUtils.map=function(b,c,d){return a.Array.map(b,c,d)},DMUtils.filter=function(b,c){return a.Array.filter(b,c)},DMUtils.trim=function(b){return a.Lang.trim(b)},g=a,b()}):a.engines.j?(g=a.engines.j,DMUtils.all=function(a,b){return Array.prototype.slice.call(g(a,b))},DMUtils.map=function(a,b){return g.map(a,b)},DMUtils.filter=function(a,b){return g.grep(a,b)},DMUtils.trim=function(a){return g.trim(a)},b()):(g=!0,b())}function c(a,b,c,d){return h[a]=new DMModule(a,b,c,d)}function d(a){var b=h[a];return b instanceof DMModule?b:!1}function e(a,b){DMUtils.each(a,function(a){i[a.name]||(i[a.name]={}),i[a.name][b.name]=b})}function f(a,b,c){DMUtils.each(a._instances,function(b){DMUtils.updateNodeState(b.node,a,h,2)&&(DMUtils.each(a._dependency,function(a){var b=d(a.name);a.context=b._add.context,a.instances=b._instances}),new DMExec(a,b.node,b.data.args,c).execute())})}var g,h={},i={};return{add:function(a,b,e,f){var g=d(a);if(g){if("function"==typeof g._add.callback)throw new Error("Module("+a+") main callback is already defined");g._add.callback=b,g._add.context=e}else g=c(a,b,e,f);return g.uuid},before:function(a,b,e,f){var g=d(a)||c(a);if("function"!=typeof b)throw new Error("Callback should be a function");return g.before(b,e,f)},after:function(a,b,e,f){var g=d(a)||c(a);if("function"!=typeof b)throw new Error("Callback should be a function");return g.after(b,e,f)},go:function(){return b(function(){var b=DMUtils.all("[data-marker]",a.env.document);DMUtils.each(Array.prototype.slice.call(b),function(a){var b=DMUtils.getModules(a,"data-marker");DMUtils.each(b,function(b){var c=d(b.name);c&&DMUtils.updateNodeState(a,c,h)&&c._instances.push({node:a,data:b})})});var c=[],g=function(){c.push(this.module.name),i[this.module.name]&&DMUtils.each(i[this.module.name],function(a){var b=0;DMUtils.each(a._dependency,function(a){~c.indexOf(a.name)&&b++}),a._dependency.length===b&&f(a,{},g),i[this.module.name]=null,delete i[this.module.name]},this)};DMUtils.each(h,function(a){0===a._dependency.length?f(a,{},g):e(a._dependency,a)})}),this},detach:function(a){var b,c,d,e,f=!1;for(b in h)if(h.hasOwnProperty(b)){if(e=h[b],e.uuid===a)e._add.context=null,e._add.callback=null,f=!0;else{for(c in e._before)if(e._before.hasOwnProperty(c)&&(d=e._before[c],d.uuid===a)){e._before.splice(c,1),f=!0;break}if(!f)for(c in e._after)if(e._after.hasOwnProperty(c)&&(d=e._after[c],d.uuid===a)){e._after.splice(c,1),f=!0;break}}if(f)break}return this},remove:function(a){return h[a]&&delete h[a],this},removeAll:function(){return h={},this}}}({env:{win:"undefined"!=typeof window&&window,document:"undefined"!=typeof document&&document},engines:{j:"function"==typeof jQuery&&jQuery,y:"function"==typeof YUI&&YUI}});